# @webpieces/dev-config Validation Rules

This document describes the validation rules provided by `@webpieces/dev-config` organized by when they run.

---

## Section 1: Workspace-Level Validations

**Runs once via `architecture:validate-complete` before any builds.**

These validations check the entire workspace architecture and run only once, regardless of how many projects are being built.

| Rule | Description | Status |
|------|-------------|--------|
| **validate-no-architecture-cycles** | Validates no cycles exist in the project dependency graph (`architecture/dependencies.json`) | ✅ TESTED |
| **validate-architecture-unchanged** | Validates `project.json` dependencies match blessed `architecture/dependencies.json` | ✅ TESTED |
| **validate-no-skiplevel-deps** | Enforces layer hierarchy - no redundant transitive dependencies | ✅ TESTED |
| **validate-packagejson** | Validates `package.json` dependencies match `project.json` build.dependsOn | ✅ TESTED |
| **validate-new-methods** | Validates new/modified methods don't exceed max line count (git-based, affected mode) | ✅ TESTED |
| **validate-versions-locked** | Validates package.json versions are locked (no ^, ~, *) and npm ci compatible | ✅ TESTED |

---

## Section 2: Per-Project Validations

**Runs on each project before build via `validate-no-file-import-cycles` in build's dependsOn.**

These validations run for each project being built, checking project-specific concerns.

| Rule | Description | Status |
|------|-------------|--------|
| **validate-no-file-import-cycles** | Uses madge to check for circular file-level imports within each project | ✅ TESTED |

---

## Section 3: ESLint Rule Validations

**Runs during the `lint` target via ESLint.**

These are ESLint rules that run during linting, enforcing code quality and architecture at the file level.

| Rule | Description | Status |
|------|-------------|--------|
| **@webpieces/enforce-architecture** | Validates code imports match blessed `architecture/dependencies.json` | ✅ TESTED |
| **@webpieces/no-unmanaged-exceptions** | No `try..catch` blocks except with `eslint-disable` comment | ✅ TESTED |
| **@webpieces/catch-error-pattern** | Enforces pattern: `catch (err: any) { const error = toError(err); }` | ✅ TESTED |
| **@webpieces/max-method-lines** | Maximum lines per method (default: 70) | ✅ TESTED |
| **@webpieces/max-file-lines** | Maximum lines per file (default: 700) | ✅ TESTED |

---

## How It All Fits Together

```
build target
  └─> dependsOn: ["architecture:validate-complete", "validate-no-file-import-cycles", "^build"]
                       │                                    │
                       │                                    └─> Per-project: madge circular check
                       │
                       └─> Workspace-level (runs once):
                             • validate-no-architecture-cycles
                             • validate-architecture-unchanged
                             • validate-no-skiplevel-deps
                             • validate-packagejson
                             • validate-new-methods
                             • validate-versions-locked

lint target
  └─> ESLint rules:
        • @webpieces/enforce-architecture
        • @webpieces/no-unmanaged-exceptions
        • @webpieces/catch-error-pattern
        • @webpieces/max-method-lines
        • @webpieces/max-file-lines
```

---

## Configuration Files

| File | Purpose |
|------|---------|
| `architecture/dependencies.json` | Blessed project dependency graph (generated by `npm run arch:generate`) |
| `eslint.webpieces.config.mjs` | ESLint configuration with @webpieces rules |
| `nx.json` | Nx configuration with targetDefaults wiring validations to builds |
| `node_modules/@webpieces/dev-config/plugin.ts` | Nx inference plugin that creates validation targets |

---

## NPM Scripts

```bash
npm run arch:generate           # Generate architecture/dependencies.json
npm run arch:visualize          # Open interactive dependency graph
npm run arch:validate           # Run workspace validations (no architecture-unchanged check)
npm run arch:validate-all       # Run all workspace validations
npm run arch:check-circular     # Run circular deps check on all projects
npm run arch:validate-complete  # Run arch:validate-all + arch:check-circular
```
